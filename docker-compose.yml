version: '3.8'

services:
  # ============================================================================
  # App 1: GSC Insights & Reporting
  # ============================================================================
  gsc-insights:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gsc-insights
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      # Persistent workspace (CRÍTICO: no se pierde al reiniciar)
      - ./workspace:/app/workspace
      # Código de la app (para desarrollo)
      - ./apps/gsc-insights:/app/apps/gsc-insights
      - ./shared:/app/shared
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
    env_file:
      - .env
    command: >
      sh -c "pip install -r /app/apps/gsc-insights/requirements.txt &&
             streamlit run /app/apps/gsc-insights/app.py
             --server.port=8501
             --server.address=0.0.0.0
             --server.headless=true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # App 2: Content Analyzer
  # ============================================================================
  content-analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: content-analyzer
    restart: unless-stopped
    ports:
      - "8502:8502"
    volumes:
      - ./workspace:/app/workspace
      - ./apps/content-analyzer:/app/apps/content-analyzer
      - ./shared:/app/shared
    environment:
      - STREAMLIT_SERVER_PORT=8502
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
    env_file:
      - .env
    command: >
      sh -c "pip install -r /app/apps/content-analyzer/requirements.txt &&
             streamlit run /app/apps/content-analyzer/app.py
             --server.port=8502
             --server.address=0.0.0.0
             --server.headless=true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8502/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # App 3: Linking Optimizer
  # ============================================================================
  linking-optimizer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linking-optimizer
    restart: unless-stopped
    ports:
      - "8503:8503"
    volumes:
      - ./workspace:/app/workspace
      - ./apps/linking-optimizer:/app/apps/linking-optimizer
      - ./shared:/app/shared
    environment:
      - STREAMLIT_SERVER_PORT=8503
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
    env_file:
      - .env
    command: >
      sh -c "pip install -r /app/apps/linking-optimizer/requirements.txt &&
             streamlit run /app/apps/linking-optimizer/app.py
             --server.port=8503
             --server.address=0.0.0.0
             --server.headless=true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8503/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # Nginx: Reverse Proxy + SSL
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro  # Para certificados SSL
    depends_on:
      - gsc-insights
      - content-analyzer
      - linking-optimizer
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

# ============================================================================
# Volumes Persistentes
# ============================================================================
volumes:
  workspace:
    driver: local

# ============================================================================
# Network
# ============================================================================
networks:
  default:
    name: embedding-insights-network
